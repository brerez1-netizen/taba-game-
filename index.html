<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ™ï¸ ×œ×•×— ×ª×›× ×•×Ÿ ×”×¢×™×¨ - ××¨×– ×‘×¨×•×›×™</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root { --blue: #38bdf8; --gold: #facc15; --bg: #020617; --card: #1e293b; }
    html, body { height: 100%; margin: 0; padding: 0; background: var(--bg); color: white; overflow: hidden; font-family: system-ui, sans-serif; }
    .main-layout { display: flex; flex-direction: row-reverse; width: 100vw; height: 100vh; }
    .board-section { flex: 3.5; display: flex; flex-direction: column-reverse; padding: 10px; gap: 8px; }
    .board-row { display: flex; flex: 1; gap: 8px; }
    .row-reverse { flex-direction: row-reverse; }
    .sidebar { flex: 1.2; background: rgba(15, 23, 42, 0.98); border-right: 3px solid var(--blue); padding: 20px; display: flex; flex-direction: column; }
    .cell { flex: 1; border-radius: 8px; border: 2px solid rgba(255,255,255,0.1); background-size: cover; background-position: center; position: relative; background-color: var(--card); overflow: hidden; }
    .milestone { border: 4px solid var(--gold); transform: scale(1.02); z-index: 5; box-shadow: 0 0 15px var(--gold); }
    .cell-title { position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.75); font-size: 0.65rem; padding: 4px 2px; text-align: center; pointer-events: none; }
    .cell-num { position: absolute; top: 3px; right: 5px; font-weight: bold; color: var(--blue); font-size: 0.9rem; text-shadow: 1px 1px 2px black; z-index: 10; }
    
    /* ××•×“××œ - ×—×œ×•×Ÿ ××™×“×¢/×©××œ×” */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 3000; }
    .modal-content { background: var(--card); padding: 40px; border-radius: 20px; border: 3px solid var(--blue); width: 600px; text-align: center; box-shadow: 0 0 30px var(--blue); }
    
    .pawn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; position: absolute; z-index: 100; transition: all 0.6s ease; border: 2px solid #000; font-size: 1.8rem; box-shadow: 0 5px 10px #000; }
    .player-entry { background: var(--card); margin-bottom: 12px; padding: 15px; border-radius: 12px; display: flex; align-items: center; border-right: 5px solid transparent; }
    .active-p { border-right-color: var(--gold); background: #2d3748; }
  </style>
</head>
<body>

<div id="gameScreen" class="main-layout">
  <div class="board-section" id="boardContainer"></div>
  <div class="sidebar">
    <h2 style="color:var(--blue); border-bottom:2px solid var(--blue); padding-bottom:10px;">××¦×‘ ×”×§×‘×•×¦×•×ª</h2>
    <div style="font-size: 4rem; text-align: center; margin: 15px 0;" id="mainDice">ğŸ²</div>
    <div id="turnText" style="font-size:1.5rem; text-align:center; margin-bottom:20px; font-weight:bold; color:var(--gold);">-</div>
    <div id="playersStatusList" style="flex:1; overflow-y:auto;"></div>
    <div id="qrcode" style="background:white; padding:10px; border-radius:10px; align-self:center;"></div>
  </div>
</div>

<div id="infoModal" class="modal">
  <div class="modal-content" id="modalBody"></div>
</div>

<script>
  const config = { apiKey: "AIzaSyDo9f15BQWkbRi99BMMOpeytdS4V8gbNg0", databaseURL: "https://erez-taba-game-default-rtdb.firebaseio.com/", projectId: "erez-taba-game" };
  firebase.initializeApp(config);
  const db = firebase.database();

  // × ×ª×•× ×™× ××§×¦×•×¢×™×™× ××”×§×•×“ ×”××§×•×¨×™
  const gameData = {
    1: { title: "×™×•×–××” ×¨×¢×™×•× ×™×ª", info: "×©×œ×‘ ×–×” ×›×•×œ×œ ×’×™×‘×•×© ×§×•× ×¡×¤×˜ ×ª×›× ×•× ×™ ×¨××©×•× ×™.", sound: "start.mp3" },
    8: { title: "×‘×“×™×§×ª ×ª× ××™ ×¡×£", info: "×”×•×•×¢×“×” ×‘×•×“×§×ª ×× ×›×œ ×”××¡××›×™× ×”×•×’×©×• ×›× ×“×¨×©.", question: "××” ×§×•×¨×” ×× ×—×¡×¨×” ×—×ª×™××ª ×‘×¢×œ×™×?", options: ["×“×—×™×™×” ×¢×œ ×”×¡×£", "×ª×™×§×•×Ÿ ×ª×•×š 7 ×™××™×"], answer: 0 },
    // ×›××Ÿ ×™×‘×•××• ×›×œ 50 ×”××©×‘×¦×•×ª ×œ×¤×™ ×”××™×“×¢ ×”××§×•×¨×™ ×©×œ×š
  };

  const stages = [ { id: 1, start: 1 }, { id: 2, start: 8 }, { id: 3, start: 16 }, { id: 4, start: 25 }, { id: 5, start: 37 } ];

  function getFileNameForCell(num) {
    let s = stages.filter(st => num >= st.start).pop();
    return `m${s.id}-${String(num - s.start + 1).padStart(2, '0')}.jpeg`;
  }

  function initBoard() {
    const container = document.getElementById('boardContainer'); container.innerHTML = '';
    for(let r=0; r<5; r++) {
      const rowDiv = document.createElement('div');
      rowDiv.className = 'board-row' + (r % 2 !== 0 ? ' row-reverse' : '');
      for(let c=1; c<=10; c++) {
        const num = (r * 10) + c;
        const cell = document.createElement('div');
        cell.className = 'cell' + (stages.some(s => s.start === num) ? ' milestone' : '');
        cell.id = `cell-${num}`;
        cell.style.backgroundImage = `url('images/${getFileNameForCell(num)}')`;
        cell.innerHTML = `<div class="cell-num">${num}</div><div class="cell-title">${gameData[num]?.title || ""}</div>`;
        rowDiv.appendChild(cell);
      }
      container.appendChild(rowDiv);
    }
  }

  function listenGame() {
    db.ref('game').on('value', s => {
      const g = s.val();
      if(g.modal) {
        const data = gameData[g.activeCell];
        document.getElementById('modalBody').innerHTML = `<h2>${data?.title || '×©×œ×‘ ×‘×ª×”×œ×™×š'}</h2><p>${data?.info || ''}</p>${data?.question ? `<div style='background:rgba(255,255,255,0.1); padding:20px; border-radius:10px;'><strong>×©××œ×”:</strong> ${data.question}</div>` : ''}`;
        document.getElementById('infoModal').style.display = 'flex';
        if(data?.sound) new Audio(`sounds/${data.sound}`).play();
      } else {
        document.getElementById('infoModal').style.display = 'none';
      }
    });
    
    db.ref('players').on('value', s => {
      const ps = s.val() || {}; const ids = Object.keys(ps);
      document.querySelectorAll('.pawn').forEach(p => p.remove());
      db.ref('game').once('value', gs => {
        const turn = gs.val().turn;
        document.getElementById('playersStatusList').innerHTML = ids.map((id, i) => {
          const p = ps[id]; const isActive = i === turn;
          const pawn = document.createElement('div');
          pawn.className = 'pawn'; pawn.innerText = p.avatar; pawn.style.background = p.color;
          document.body.appendChild(pawn);
          const cell = document.getElementById(`cell-${p.pos + 1}`);
          if(cell) { 
             const r = cell.getBoundingClientRect(); 
             pawn.style.top = (r.top + 5) + "px"; pawn.style.left = (r.left + 5) + "px"; 
          }
          return `<div class="player-entry ${isActive ? 'active-p' : ''}"><div>${p.avatar}</div><div style="margin-right:10px;"><b>${p.name}</b><br><small>××©×‘×¦×ª ${p.pos+1}</small></div></div>`;
        }).join('');
      });
    });
  }

  initBoard(); listenGame();
  new QRCode(document.getElementById("qrcode"), { text: window.location.href.replace('index.html', 'play.html'), width: 100, height: 100 });
</script>
</body>
</html>
