<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ“± ×©×œ×˜ ×¡×˜×•×“× ×˜ - ××¡×œ×•×œ ×”×ª×‘"×¢</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="js/gameData.js?v=final"></script>
  <style>
    :root { --blue: #38bdf8; --bg: #020617; --card: #1e293b; --green: #22c55e; }
    body { background: var(--bg); color: white; font-family: system-ui; text-align: center; padding: 20px; margin: 0; touch-action: manipulation; }
    .card { background: var(--card); padding: 25px; border-radius: 25px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .btn { background: var(--blue); color: black; border: none; padding: 25px; border-radius: 20px; font-size: 1.8rem; font-weight: bold; width: 100%; margin-top: 15px; box-shadow: 0 6px 0 #0369a1; }
    .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; }
    .opt-btn { background: var(--card); color: white; border: 4px solid var(--blue); padding: 65px 10px; border-radius: 35px; font-size: 4.5rem; font-weight: bold; box-shadow: 0 8px 0 #0369a1; }
    .char-item { font-size: 3rem; padding: 15px; border: 3px solid transparent; border-radius: 15px; cursor: pointer; background: rgba(255,255,255,0.05); }
    .selected { border-color: var(--blue); background: var(--card); }
  </style>
</head>
<body>

<div id="setupView">
  <h2 style="font-size: 2.2rem; color: var(--blue);">×”×¦×˜×¨×¤×•×ª ×œ×•×•×¢×“×”</h2>
  <div class="card">
    <input type="text" id="pName" placeholder="×©× ×”×§×‘×•×¦×”" style="width:100%; padding:20px; border-radius:15px; font-size:1.6rem; border:none; margin-bottom:20px;">
    <div id="charList" style="display:flex; justify-content:center; gap:10px; margin-bottom:35px;"></div>
    <button class="btn" style="background:var(--green); box-shadow: 0 6px 0 #166534;" onclick="join()">ğŸš€ ×”×™×›× ×¡ ×œ×œ×•×‘×™</button>
  </div>
</div>

<div id="gameView" style="display:none;">
  <h1 id="myName" style="font-size: 2.5rem; margin: 0;">...</h1>
  <div id="status-msg" style="color:var(--blue); font-weight:bold; margin: 25px 0; font-size: 1.8rem;"></div>
  <button id="rollBtn" class="btn" style="display:none; background:var(--green); box-shadow: 0 6px 0 #166534;" onclick="roll()">ğŸ² ×”×˜×œ ×§×•×‘×™×™×”</button>
  <div id="quizArea" style="display: none;"><div class="opt-grid">
      <button class="opt-btn" onclick="sendAns(0)">×</button>
      <button class="opt-btn" onclick="sendAns(1)">×‘</button>
      <button class="opt-btn" onclick="sendAns(2)">×’</button>
      <button class="opt-btn" onclick="sendAns(3)">×“</button>
  </div></div>
  <div id="wheelArea" style="display: none;"><button class="btn" style="background:#eab308; box-shadow: 0 6px 0 #a16207; padding: 60px 10px; font-size: 2.5rem;" onclick="spin()">ğŸ¡ ×¡×•×‘×‘ ×’×œ×’×œ!</button></div>
</div>

<script>
  const config = { apiKey: "AIzaSyDo9f15BQWkbRi99BMMOpeytdS4V8gbNg0", databaseURL: "https://erez-taba-game-default-rtdb.firebaseio.com/", projectId: "erez-taba-game" };
  firebase.initializeApp(config);
  const db = firebase.database();
  let myId = localStorage.getItem('game_id') || ("p_" + Date.now());
  let selectedIcon = "ğŸ—ï¸";

  function initChars() {
    if(!window.gameData) return setTimeout(initChars, 400);
    const list = document.getElementById('charList'); list.innerHTML = '';
    window.gameData.characters.forEach(c => {
      const el = document.createElement('div'); el.className = 'char-item'; el.innerText = c.icon;
      el.onclick = () => { document.querySelectorAll('.char-item').forEach(i=>i.classList.remove('selected')); el.classList.add('selected'); selectedIcon = c.icon; };
      list.appendChild(el);
    });
  }

  function join() {
    const name = document.getElementById('pName').value; if(!name) return alert("× × ×œ×”×–×™×Ÿ ×©× ×§×‘×•×¦×”");
    db.ref('players/' + myId).set({ name, icon: selectedIcon, color: '#38bdf8', pos: -1, score: 0 });
    localStorage.setItem('game_id', myId); showGame();
  }

  function showGame() {
    document.getElementById('setupView').style.display = 'none'; document.getElementById('gameView').style.display = 'block';
    db.ref('game').on('value', snap => {
      const g = snap.val() || { turn: 0, turnOrder: [] };
      db.ref('players').on('value', psSnap => {
        const ps = psSnap.val() || {}; const me = ps[myId]; if(!me) return;
        const isMyTurn = g.turnOrder && g.turnOrder[g.turn] === myId;
        document.getElementById('myName').innerText = me.icon + " " + me.name + " (" + (me.score || 0) + ")";
        document.getElementById('status-msg').innerText = isMyTurn ? "×ª×•×¨×š ×”×’×™×¢! ğŸŒŸ" : "×”××ª×Ÿ...";
        const data = window.gameData.cells[g.activeCell];
        document.getElementById('rollBtn').style.display = (isMyTurn && !g.activeCell) ? 'block' : 'none';
        document.getElementById('quizArea').style.display = (isMyTurn && data?.type === 'quiz' && (g.selection === null || g.selection === undefined)) ? 'block' : 'none';
        document.getElementById('wheelArea').style.display = (isMyTurn && data?.type === 'wheel' && !g.wheelResult) ? 'block' : 'none';
      });
    });
  }

  function roll() { 
    const r = Math.floor(Math.random()*6)+1;
    db.ref('game').update({ state: 'moving', lastRoll: r, selection: null, wheelResult: null });
    db.ref('players/'+myId).once('value', s => {
      const currentPos = s.val().pos < 0 ? -1 : s.val().pos;
      const newPos = Math.min(currentPos + r, 49);
      db.ref('players/'+myId).update({ pos: newPos });
      db.ref('game').update({ state: 'playing', activeCell: newPos + 1 });
    });
  }

  async function sendAns(idx) {
    const gSnap = await db.ref('game').once('value'); const g = gSnap.val();
    const data = window.gameData.cells[g.activeCell]; const pSnap = await db.ref('players/' + myId).once('value'); const p = pSnap.val();
    let bonus = (idx === data.correct) ? Math.max(50, 100 - Math.round(((Date.now() - g.startTime)/1000)*3)) : 0;
    const move = (idx === data.correct) ? (data.correctMove || 0) : (data.wrongMove || 0);
    await db.ref('players/' + myId).update({ score: (p.score || 0) + bonus, pos: Math.max(0, Math.min(p.pos + move, 49)) });
    db.ref('game').update({ selection: idx });
  }

  function spin() {
    const rot = 1440 + Math.floor(Math.random() * 360);
    db.ref('game').update({ state: 'wheeling', wheelRotation: rot });
    setTimeout(() => {
      db.ref('game').once('value', gSnap => {
        const cell = window.gameData.cells[gSnap.val().activeCell];
        const normalized = rot % 360;
        let resIndex = (normalized < 120) ? 0 : (normalized < 240 ? 1 : 2);
        const res = cell.outcomes[resIndex];
        db.ref('game').update({ state: 'playing', wheelResult: "×ª×•×¦××”: " + res.text });
        db.ref('players/'+myId).once('value', s => { db.ref('players/'+myId).update({ pos: Math.max(0, Math.min(s.val().pos + res.move, 49)) }); });
      });
    }, 3100);
  }

  initChars(); db.ref('players/' + myId).once('value', s => { if(s.exists()) showGame(); });
</script>
</body>
</html>
