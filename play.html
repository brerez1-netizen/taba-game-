<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ“± ×©×œ×˜ ×¡×˜×•×“× ×˜</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="js/gameData.js?v=4.1"></script>
  <style>
    :root { --blue: #38bdf8; --bg: #020617; --card: #1e293b; --green: #22c55e; --gold: #facc15; }
    body { background: var(--bg); color: white; font-family: system-ui; text-align: center; padding: 20px; margin: 0; }
    .card { background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
    .btn { background: var(--blue); color: black; border: none; padding: 20px; border-radius: 15px; font-size: 1.5rem; font-weight: bold; width: 100%; cursor: pointer; }
    .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .opt-btn { background: var(--card); color: white; border: 3px solid var(--blue); padding: 40px; border-radius: 20px; font-size: 3rem; font-weight: bold; box-shadow: 0 6px 0 #0369a1; }
    .opt-btn:active { transform: translateY(4px); box-shadow: none; }
    .char-item { font-size: 2.5rem; padding: 10px; border: 2px solid transparent; border-radius: 12px; cursor: pointer; background: rgba(255,255,255,0.05); }
    .selected { border-color: var(--blue); background: var(--card); }
  </style>
</head>
<body>

<div id="setupView">
  <h2>×”×¦×˜×¨×¤×•×ª ×œ×•×•×¢×“×”</h2>
  <div class="card">
    <input type="text" id="pName" placeholder="×©× ×”×§×‘×•×¦×”" style="width:100%; padding:15px; border-radius:10px; border:none; margin-bottom:15px; font-size:1.1rem;">
    <div style="display:flex; justify-content:center; gap:10px; margin-bottom:20px;" id="charList"></div>
    <button class="btn" style="background:var(--green);" onclick="join()">ğŸš€ ×”×™×›× ×¡ ×œ×œ×•×‘×™</button>
  </div>
</div>

<div id="gameView" style="display:none;">
  <h1 id="myName">...</h1>
  <div id="status-msg" style="color:var(--blue); font-weight:bold; margin-bottom:20px; font-size:1.4rem;"></div>

  <button id="rollBtn" class="btn" style="display:none; background:var(--green);" onclick="roll()">ğŸ² ×”×˜×œ ×§×•×‘×™×™×”</button>

  <div id="quizArea" style="display: none;">
    <h3 style="color:var(--gold);">×‘×—×¨ ×ª×©×•×‘×”:</h3>
    <div class="opt-grid">
      <button class="opt-btn" onclick="sendAns(0)">×</button>
      <button class="opt-btn" onclick="sendAns(1)">×‘</button>
      <button class="opt-btn" onclick="sendAns(2)">×’</button>
      <button class="opt-btn" onclick="sendAns(3)">×“</button>
    </div>
  </div>

  <div id="wheelArea" style="display: none;">
    <button class="btn" style="background:var(--gold); padding:40px 10px;" onclick="spin()">ğŸ¡ ×¡×•×‘×‘ ×’×œ×’×œ ××–×œ!</button>
  </div>
</div>

<script>
  const config = { apiKey: "AIzaSyDo9f15BQWkbRi99BMMOpeytdS4V8gbNg0", databaseURL: "https://erez-taba-game-default-rtdb.firebaseio.com/", projectId: "erez-taba-game" };
  firebase.initializeApp(config);
  const db = firebase.database();
  let myId = localStorage.getItem('game_id') || ("p_" + Date.now());
  let selectedIcon = "ğŸ—ï¸";

  function initChars() {
    if(!window.gameData) return setTimeout(initChars, 300);
    const list = document.getElementById('charList');
    window.gameData.characters.forEach(c => {
      const el = document.createElement('div');
      el.className = 'char-item'; el.innerText = c.icon;
      el.onclick = () => { document.querySelectorAll('.char-item').forEach(i=>i.classList.remove('selected')); el.classList.add('selected'); selectedIcon = c.icon; };
      list.appendChild(el);
    });
  }

  function join() {
    const name = document.getElementById('pName').value;
    if(!name) return alert("× × ×œ×”×–×™×Ÿ ×©× ×§×‘×•×¦×”");
    db.ref('players/' + myId).set({ name, icon: selectedIcon, color: '#38bdf8', pos: 0 });
    localStorage.setItem('game_id', myId);
    showGame();
  }

  function showGame() {
    document.getElementById('setupView').style.display = 'none';
    document.getElementById('gameView').style.display = 'block';
    
    db.ref('game').on('value', snap => {
      const g = snap.val() || { turn: 0, turnOrder: [] };
      db.ref('players').on('value', pSnap => {
        const ps = pSnap.val() || {};
        const me = ps[myId];
        if(!me) return;

        const isMyTurn = g.turnOrder && g.turnOrder[g.turn] === myId;
        document.getElementById('myName').innerText = me.icon + " " + me.name;
        document.getElementById('status-msg').innerText = isMyTurn ? "×ª×•×¨×š ×”×’×™×¢! ğŸŒŸ" : "×”××ª×Ÿ ×œ×ª×•×¨ ×”×§×‘×•×¦×” ×”×‘××”...";
        
        const cellData = window.gameData.cells[g.activeCell];
        
        // ×”×¦×’×ª ×›×¤×ª×•×¨×™× ×¨×§ ×›×©×”×ª× ××™× ××ª×§×™×™××™×
        document.getElementById('rollBtn').style.display = (isMyTurn && !g.activeCell) ? 'block' : 'none';
        document.getElementById('quizArea').style.display = (isMyTurn && (cellData?.type === 'quiz' || cellData?.type === 'knowledge') && (g.selection === null || g.selection === undefined)) ? 'block' : 'none';
        document.getElementById('wheelArea').style.display = (isMyTurn && cellData?.type === 'wheel' && !g.wheelResult) ? 'block' : 'none';
      });
    });
  }

  function roll() { 
    const r = Math.floor(Math.random()*6)+1;
    db.ref('game').update({ state: 'moving', lastRoll: r, selection: null, wheelResult: null });
    db.ref('players/'+myId).once('value', s => {
      const newPos = Math.min(s.val().pos + r, 49);
      db.ref('players/'+myId).update({ pos: newPos });
      db.ref('game').update({ state: 'playing', activeCell: newPos + 1 });
    });
  }

  function sendAns(i) { db.ref('game').update({ selection: i }); }

  function spin() {
    db.ref('game').update({ state: 'wheeling' });
    setTimeout(() => {
      db.ref('game').once('value', gSnap => {
        const cell = window.gameData.cells[gSnap.val().activeCell];
        const res = cell.outcomes[Math.floor(Math.random()*cell.outcomes.length)];
        db.ref('game').update({ state: 'playing', wheelResult: "×ª×•×¦××”: " + res.text });
        db.ref('players/'+myId).once('value', s => { 
            db.ref('players/'+myId).update({ pos: Math.max(0, Math.min(s.val().pos + res.move, 49)) }); 
        });
      });
    }, 2000);
  }

  initChars();
  db.ref('players/' + myId).once('value', s => { if(s.exists()) showGame(); });
</script>
</body>
</html>
