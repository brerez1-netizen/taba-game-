<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ“± ×©×—×§×Ÿ - ××¡×œ×•×œ ×”×ª×‘"×¢</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    :root { --blue: #38bdf8; --gold: #facc15; --bg: #020617; --card: #1e293b; --red: #ef4444; --green: #22c55e; }
    body { background: var(--bg); color: white; font-family: system-ui, -apple-system, sans-serif; text-align: center; margin: 0; padding: 20px; overflow-x: hidden; }
    
    .container { max-width: 500px; margin: 0 auto; }
    .card { background: var(--card); padding: 25px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    
    input, select { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--blue); background: #0f172a; color: white; font-size: 1.1rem; box-sizing: border-box; }
    
    .btn { background: var(--blue); color: #020617; border: none; padding: 18px; border-radius: 15px; font-size: 1.3rem; font-weight: bold; width: 100%; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 0 #0284c7; }
    .btn:active { transform: translateY(3px); box-shadow: none; }
    .btn:disabled { background: #475569; box-shadow: none; cursor: not-allowed; opacity: 0.6; }

    /* ×¢×™×¦×•×‘ ××¢×¨×š ×”×ª×©×•×‘×•×ª */
    .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .opt-btn { background: #1e293b; color: white; border: 2px solid var(--blue); padding: 25px; border-radius: 15px; font-size: 1.5rem; font-weight: bold; }
    .opt-btn.selected { background: var(--blue); color: black; }

    #status-msg { font-size: 1.2rem; color: var(--gold); margin: 15px 0; min-height: 1.5em; }
    .avatar-display { font-size: 4rem; margin: 20px 0; }
  </style>
</head>
<body>

<div class="container">
  <div id="setupView">
    <h1 style="color: var(--blue);">×”×¦×˜×¨×¤×•×ª ×œ××¡×œ×•×œ</h1>
    <div class="card">
      <input type="text" id="playerName" placeholder="×©× ×”×§×‘×•×¦×” / ×¡×˜×•×“× ×˜">
      <select id="playerAvatar">
        <option value="ğŸ—ï¸">ğŸ—ï¸ ×× ×•×£</option>
        <option value="ğŸ ">ğŸ  ×‘×™×ª ×¤×¨×˜×™</option>
        <option value="ğŸ“">ğŸ“ ×¡×¨×’×œ ××“×™×“×”</option>
        <option value="ğŸ™ï¸">ğŸ™ï¸ ×¨×‘ ×§×•××•×ª</option>
        <option value="ğŸšœ">ğŸšœ ×˜×¨×§×˜×•×¨</option>
      </select>
      <button class="btn" onclick="joinGame()">ğŸš€ ×”×™×›× ×¡ ×œ××©×—×§</button>
    </div>
  </div>

  <div id="gameView" style="display: none;">
    <div id="status-msg">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
    
    <div class="card">
      <div id="avatarBox" class="avatar-display"></div>
      <h2 id="nameBox"></h2>
      <div id="posBox" style="color: var(--blue);">××©×‘×¦×ª: 1</div>
    </div>

    <div id="diceSection" style="display: none;">
      <button id="rollBtn" class="btn" onclick="rollDice()">ğŸ² ×”×˜×œ ×§×•×‘×™×™×”</button>
    </div>

    <div id="quizSection" style="display: none;">
      <h3 style="color: var(--gold);">×‘×—×¨ ×ª×©×•×‘×”:</h3>
      <div class="quiz-grid">
        <button class="opt-btn" onclick="submitAnswer(0)">×</button>
        <button class="opt-btn" onclick="submitAnswer(1)">×‘</button>
        <button class="opt-btn" onclick="submitAnswer(2)">×’</button>
        <button class="opt-btn" onclick="submitAnswer(3)">×“</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ×”×’×“×¨×•×ª Firebase - ×–×”×•×ª ×œ××¡×š ×”××¨×¦×”
  const config = { 
    apiKey: "AIzaSyDo9f15BQWkbRi99BMMOpeytdS4V8gbNg0", 
    databaseURL: "https://erez-taba-game-default-rtdb.firebaseio.com/", 
    projectId: "erez-taba-game" 
  };
  firebase.initializeApp(config);
  const db = firebase.database();

  let myId = localStorage.getItem('erez_game_id') || null;
  let myData = null;

  // ×”×¦×˜×¨×¤×•×ª ×œ××©×—×§
  function joinGame() {
    const name = document.getElementById('playerName').value;
    const avatar = document.getElementById('playerAvatar').value;
    if (!name) return alert("× × ×œ×”×–×™×Ÿ ×©×");

    myId = "p_" + Date.now();
    myData = {
      name: name,
      avatar: avatar,
      pos: 0,
      color: '#' + Math.floor(Math.random()*16777215).toString(16),
      lastActive: Date.now()
    };

    db.ref('players/' + myId).set(myData);
    localStorage.setItem('erez_game_id', myId);
    
    showGameView();
  }

  function showGameView() {
    document.getElementById('setupView').style.display = 'none';
    document.getElementById('gameView').style.display = 'block';
    startListening();
  }

  function startListening() {
    // ×”××–× ×” ×œ××¦×‘ ×”××©×—×§ ×”×›×œ×œ×™
    db.ref('game').on('value', snapshot => {
      const game = snapshot.val() || {};
      
      db.ref('players').once('value', pSnap => {
        const players = pSnap.val() || {};
        const playerIds = Object.keys(players);
        const currentPlayerId = playerIds[game.turn];
        const isMyTurn = (currentPlayerId === myId);

        // ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×ª×•×¨
        const statusMsg = document.getElementById('status-msg');
        if (isMyTurn) {
          statusMsg.innerText = "×–×” ×”×ª×•×¨ ×©×œ×š! ğŸŒŸ";
          statusMsg.style.color = "var(--gold)";
        } else {
          const activeName = players[currentPlayerId]?.name || "××™×©×”×• ××—×¨";
          statusMsg.innerText = "×”××ª×Ÿ ×‘×¡×‘×œ× ×•×ª... ×ª×•×¨ " + activeName;
          statusMsg.style.color = "white";
        }

        // × ×™×”×•×œ ×ª×¦×•×’×ª ×§×•×‘×™×™×”
        // ××¦×™×’×™× ×§×•×‘×™×™×” ×¨×§ ×× ×–×” ×ª×•×¨×™ ×•××™×Ÿ ×›×¨×’×¢ ×©××œ×” ×¤×ª×•×—×” ××• ×ª× ×•×¢×”
        document.getElementById('diceSection').style.display = 
          (isMyTurn && !game.activeCell && game.state !== 'moving') ? 'block' : 'none';

        // × ×™×”×•×œ ×ª×¦×•×’×ª ×©××œ×•×ª
        // ××¦×™×’×™× ×©××œ×•×ª ×¨×§ ×× ×”×©×—×§×Ÿ ×”× ×•×›×—×™ (×‘×ª×•×¨×•) × ××¦× ×¢×œ ××©×‘×¦×ª ×¤×¢×™×œ×”
        document.getElementById('quizSection').style.display = 
          (isMyTurn && game.activeCell) ? 'block' : 'none';
        
        // ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×©×—×§×Ÿ ×©×œ×™
        if (players[myId]) {
          document.getElementById('avatarBox').innerText = players[myId].avatar;
          document.getElementById('nameBox').innerText = players[myId].name;
          document.getElementById('posBox').innerText = "××©×‘×¦×ª: " + (players[myId].pos + 1);
        }
      });
    });
  }

  function rollDice() {
    const roll = Math.floor(Math.random() * 6) + 1;
    // ×¢×“×›×•×Ÿ ×”-Firebase ×›×“×™ ×©×”××¨×¦×” ×™×¨××” ××ª ×”×”×’×¨×œ×”
    db.ref('game').update({ 
      lastRoll: roll, 
      state: 'moving',
      selection: null // ××™×¤×•×¡ ×‘×—×™×¨×” ×§×•×“××ª
    });
  }

  function submitAnswer(index) {
    // ×©×œ×™×—×ª ×”×‘×—×™×¨×” ×œ-Firebase - ×”××¨×¦×” ×™×¨××” ××ª ×–×” ××™×“
    db.ref('game').update({ selection: index });
    
    // ×¡×™××•×Ÿ ×•×™×–×•××œ×™ ××§×•××™
    const btns = document.querySelectorAll('.opt-btn');
    btns.forEach((b, i) => {
      b.classList.toggle('selected', i === index);
    });
  }

  // ×‘×“×™×§×” ×× ×”×©×—×§×Ÿ ×›×‘×¨ ×¨×©×•×
  if (myId) {
    db.ref('players/' + myId).once('value', s => {
      if (s.exists()) showGameView();
      else localStorage.removeItem('erez_game_id');
    });
  }
</script>
</body>
</html>
