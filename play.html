<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ğŸ“± ×©×—×§×Ÿ - ××¡×œ×•×œ ×”×ª×‘"×¢</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    :root { --blue: #38bdf8; --gold: #facc15; --bg: #020617; --card: #1e293b; }
    body { background: var(--bg); color: white; font-family: system-ui, sans-serif; text-align: center; margin: 0; padding: 20px; transition: 0.5s; overflow-x: hidden; }
    .card { background: var(--card); padding: 20px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
    input { width: 100%; padding: 15px; margin: 10px 0; border-radius: 12px; border: 1px solid var(--blue); background: #0f172a; color: white; font-size: 1.1rem; box-sizing: border-box; }
    .btn { background: var(--blue); color: #020617; border: none; padding: 18px; border-radius: 15px; font-size: 1.3rem; font-weight: bold; width: 100%; cursor: pointer; box-shadow: 0 4px 0 #0284c7; }
    .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
    .avatar-opt { font-size: 1.8rem; padding: 10px; border: 2px solid transparent; border-radius: 12px; cursor: pointer; background: #0f172a; }
    .avatar-opt.selected { border-color: var(--gold); background: var(--card); }
    #status-msg { font-size: 1.3rem; margin-bottom: 15px; font-weight: bold; color: var(--gold); }
  </style>
</head>
<body id="pBody">

<div id="setupView">
  <h1>×”×’×“×¨×ª ×§×‘×•×¦×”</h1>
  <div class="card">
    <input type="text" id="pName" placeholder="×©× ×”×§×‘×•×¦×”">
    <div class="avatar-grid">
      <div class="avatar-opt" onclick="selAv(this, 'ğŸ—ï¸')">ğŸ—ï¸</div>
      <div class="avatar-opt" onclick="selAv(this, 'ğŸ ')">ğŸ </div>
      <div class="avatar-opt" onclick="selAv(this, 'ğŸ“')">ğŸ“</div>
      <div class="avatar-opt" onclick="selAv(this, 'ğŸšœ')">ğŸšœ</div>
    </div>
    <input type="color" id="pColor" value="#38bdf8" style="height:50px;">
    <button class="btn" style="margin-top:20px;" onclick="join()">ğŸš€ ×”×¦×˜×¨×£ ×œ××©×—×§</button>
  </div>
</div>

<div id="gameView" style="display: none;">
  <div id="status-msg">××ª×—×‘×¨...</div>
  <div class="card">
    <div id="avBox" style="font-size: 4.5rem;"></div>
    <h2 id="nameBox" style="margin: 0;"></h2>
    <div id="posBox" style="color: var(--blue); font-size: 1.2rem;"></div>
  </div>
  <button id="rollBtn" class="btn" style="display:none; margin-top:20px;" onclick="roll()">ğŸ² ×”×˜×œ ×§×•×‘×™×™×”</button>
</div>

<script>
  const config = { apiKey: "AIzaSyDo9f15BQWkbRi99BMMOpeytdS4V8gbNg0", databaseURL: "https://erez-taba-game-default-rtdb.firebaseio.com/", projectId: "erez-taba-game" };
  firebase.initializeApp(config);
  const db = firebase.database();

  let myId = localStorage.getItem('erez_game_id');
  let selectedAvatar = "ğŸ—ï¸";

  function selAv(el, av) {
    document.querySelectorAll('.avatar-opt').forEach(a => a.classList.remove('selected'));
    el.classList.add('selected');
    selectedAvatar = av;
  }

  function join() {
    const name = document.getElementById('pName').value;
    const color = document.getElementById('pColor').value;
    if (!name) return alert("× × ×œ×”×–×™×Ÿ ×©×");
    myId = "p_" + Date.now();
    db.ref('players/' + myId).set({ name, avatar: selectedAvatar, color, pos: 0 });
    localStorage.setItem('erez_game_id', myId);
    showGame();
  }

  function showGame() {
    document.getElementById('setupView').style.display = 'none';
    document.getElementById('gameView').style.display = 'block';
    
    db.ref('game').on('value', snap => {
      const g = snap.val() || { state: 'lobby' };
      db.ref('players').on('value', pSnap => {
        const ps = pSnap.val() || {};
        if (!ps[myId]) { localStorage.removeItem('erez_game_id'); location.reload(); return; }
        
        const ids = Object.keys(ps);
        const isMyTurn = ids[g.turn] === myId;
        document.getElementById('status-msg').innerText = isMyTurn ? "×–×” ×”×ª×•×¨ ×©×œ×š! ğŸŒŸ" : "×”××ª×Ÿ ×œ×”×—×œ×˜×ª ×”×•×•×¢×“×”...";
        document.getElementById('rollBtn').style.display = (isMyTurn && !g.activeCell && g.state === 'playing') ? 'block' : 'none';
        
        const me = ps[myId];
        document.getElementById('avBox').innerText = me.avatar;
        document.getElementById('nameBox').innerText = me.name;
        document.getElementById('posBox').innerText = "××©×‘×¦×ª " + (me.pos + 1);
        document.getElementById('pBody').style.background = `linear-gradient(180deg, ${me.color}22 0%, #020617 100%)`;
      });
    });
  }

  function roll() { db.ref('game').update({ lastRoll: Math.floor(Math.random()*6)+1, state: 'moving' }); }

  if (myId) {
    db.ref('players/' + myId).once('value', s => { if (s.exists()) showGame(); else localStorage.removeItem('erez_game_id'); });
  }
</script>
</body>
</html>
