<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title> 砖 住</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="js/gameData.js?v=1.3"></script>
  <style>
    :root { --blue: #38bdf8; --bg: #020617; --card: #1e293b; --green: #22c55e; }
    body { background: var(--bg); color: white; font-family: system-ui; text-align: center; padding: 20px; margin: 0; }
    .btn { background: var(--blue); color: #020617; border: none; padding: 20px; border-radius: 15px; font-size: 1.5rem; font-weight: bold; width: 100%; cursor: pointer; margin-top: 15px; }
    .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
    .opt-btn { background: var(--card); color: white; border: 3px solid var(--blue); padding: 35px; border-radius: 20px; font-size: 2.5rem; font-weight: bold; }
    .opt-btn:active { background: var(--blue); color: black; }
  </style>
</head>
<body>

<div id="gameView">
  <h2 id="nameBox">转专...</h2>
  <div id="status-msg" style="color:var(--blue); font-weight:bold; margin-bottom:20px;"></div>

  <button id="rollBtn" class="btn" style="display:none; background:var(--green);" onclick="roll()">  拽</button>

  <div id="quizArea" style="display: none;">
    <h3>专 转砖:</h3>
    <div class="opt-grid">
      <button class="opt-btn" onclick="sendAns(0)"></button>
      <button class="opt-btn" onclick="sendAns(1)"></button>
      <button class="opt-btn" onclick="sendAns(2)"></button>
      <button class="opt-btn" onclick="sendAns(3)"></button>
    </div>
  </div>

  <div id="wheelArea" style="display: none;">
    <button class="btn" style="background:var(--green);" onclick="spin()"> 住  !</button>
  </div>
</div>

<script>
  const config = { apiKey: "AIzaSyDo9f15BQWkbRi99BMMOpeytdS4V8gbNg0", databaseURL: "https://erez-taba-game-default-rtdb.firebaseio.com/", projectId: "erez-taba-game" };
  firebase.initializeApp(config);
  const db = firebase.database();
  let myId = localStorage.getItem('erez_game_id') || ("p_" + Date.now());
  localStorage.setItem('erez_game_id', myId);

  // 爪专驻转 转   砖
  db.ref('players/' + myId).once('value', s => {
    if(!s.exists()) db.ref('players/' + myId).set({ name: "拽爪 " + myId.slice(-3), color: "#38bdf8", pos: 0 });
  });

  db.ref('game').on('value', snap => {
    const g = snap.val() || { turn: 0 };
    db.ref('players').once('value', pSnap => {
      const ps = pSnap.val() || {};
      const ids = Object.keys(ps);
      const isMyTurn = ids[g.turn] === myId;
      const me = ps[myId];
      
      document.getElementById('nameBox').innerText = me?.name || "注...";
      document.getElementById('status-msg').innerText = isMyTurn ? "转专 注! " : "转 专...";
      
      // 爪转 驻转专 驻 住 砖爪转
      const data = window.gameData ? window.gameData[g.activeCell] : null;
      document.getElementById('rollBtn').style.display = (isMyTurn && !g.activeCell) ? 'block' : 'none';
      document.getElementById('quizArea').style.display = (isMyTurn && data?.type === 'quiz' && g.selection === null) ? 'block' : 'none';
      document.getElementById('wheelArea').style.display = (isMyTurn && data?.type === 'wheel' && !g.wheelResult) ? 'block' : 'none';
    });
  });

  function roll() { db.ref('game').update({ lastRoll: Math.floor(Math.random()*6)+1, state: 'moving', selection: null, wheelResult: null }); }
  function sendAns(idx) { db.ref('game').update({ selection: idx }); }
  function spin() {
    db.ref('game').update({ state: 'wheeling' });
    setTimeout(() => {
      const outcomes = [-3, -2, -1, 0, 1, 2, 3]; // 驻砖专转 转注 
      const res = outcomes[Math.floor(Math.random()*outcomes.length)];
      db.ref('game').update({ state: 'moving', lastRoll: res, wheelResult: (res >= 0 ? "+" : "") + res + " 砖爪转" });
    }, 2000);
  }
</script>
</body>
</html>
